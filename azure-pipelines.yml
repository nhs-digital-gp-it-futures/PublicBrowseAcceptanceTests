trigger:
- development

pr:
- development

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: MSBUILDSINGLELOADCONTEXT
    value: '1'
  - name: BROWSER
    value: chrome
  - name: DB__SERVERURL
    value: gpitfutures-dev-sql-pri.database.windows.net
  - name: DB__DATABASENAME
    value: bc-buyingcatalogue-development-helm-bapi
  - name: AZUREBLOBSTORAGE__CONTAINERNAME
    value: buyingcatalogue-development-helm-documents
  - group: dev-secrets

steps:
- bash: |
    echo "##vso[task.setvariable variable=PBHOSTURL]$(echo "${PBURL#'https://'}")"
  displayName: Set up PB Host URL

- bash: |
    echo "51.11.46.27    $PBHOSTURL" | sudo tee -a /etc/hosts
    curl -k -i $(PBURL) --fail --connect-timeout 30
  displayName: 'Check URL is reachable'

- bash: |
    export PBHOSTURL
    docker-compose stop &&
    docker-compose rm -f &&
    docker-compose up --scale chrome=4 -d

    n=0
    until [ "$n" -ge 30 ]
    do
      chromeNodeNames=$(docker ps --filter "name=chrome" --format "table {{.Names}}")
      firstNode=$(echo $chromeNodeNames | cut -d" " -f2)
      status=$(docker inspect --format "{{json .State.Health.Status }}" "$firstNode" | tr -d '"')
      
      if [ "$status" = "healthy" ]; then exit 0; fi
      n=$((n+1)) 
      sleep 1
    done

    echo "Selenium grid cannot access $PBHOSTURL"
    exit 1
  displayName: Selenium Grid Setup

- bash: |
    export DB__PASSWORD="$(gpitfuturesdevdbpassword)" 
    export AZUREBLOBSTORAGE__CONNECTIONSTRING="$(gpitdevstorageaccountconnectionstring)"

    dotnet test src/NHSDPublicBrowseAcceptanceTests.Tests/*.csproj -v n
  displayName: Run Acceptance Tests
  
- task: Docker@2
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/development')
  inputs:
    containerRegistry: 'gpitfuturesdevacr'
    repository: 'nhsd/buying-catalogue/pb-ac-tests'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: latest
    addPipelineData: false


