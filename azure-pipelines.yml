# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
- development

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: BROWSER
    value: chrome
  - name: DB__SERVERURL
    value: gpitfutures-dev-sql-pri.database.windows.net
  - name: DB__DATABASENAME
    value: bc-buyingcatalogue-development-helm-bapi
  - name: AZUREBLOBSTORAGE__CONTAINERNAME
    value: buyingcatalogue-development-helm-documents
  - group: dev-secrets

steps:
- task: UseDotNet@2
  displayName: 'Use DotNet Core 3.1'
  inputs:
    version: '3.1.x'
    includePreviewVersions: false

- task: Docker@2
  inputs:
    command: 'build'
    Dockerfile: 'Dockerfile'

#- task: CopyFiles@2
#  enabled: false
#  inputs:
#    Contents: '**'
#    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    
#- task: PublishBuildArtifacts@1
#  enabled: false
#  inputs:
#    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
#    ArtifactName: 'drop'
#    publishLocation: 'Container'
      
#- bash: 
#    "curl -k -i $(PBURL) --fail --connect-timeout 30"
#  displayName: 'Check URL is reachable'

#- task: Bash@3
#  displayName: Selenium Grid Setup
#  inputs:
#    targetType: 'inline'
#    script: |
#      docker-compose stop &&
#      docker-compose rm -f &&
#      docker-compose up --scale chrome=4 --scale firefox=4  -d
    
#- bash: |
#    export DB__PASSWORD="$(gpitfuturesdevdbpassword)"
#    export AZUREBLOBSTORAGE__CONNECTIONSTRING="$(gpitdevstorageaccountconnectionstring)"
#    
#    dotnet test src/NHSDPublicBrowseAcceptanceTests.Tests/*.csproj -v n
#  name: runTests
#  displayName: Run Acceptance Tests

