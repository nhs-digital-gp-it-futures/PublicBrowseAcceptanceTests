trigger:
- development

pr:
- development

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: dotnetVersion
    value: '3.1.x'
  - name: MSBUILDSINGLELOADCONTEXT
    value: '1'
  - name: BROWSER
    value: chrome
  - name: DB__SERVERURL
    value: gpitfutures-dev-sql-pri.database.windows.net
  - name: DB__DATABASENAME
    value: bc-buyingcatalogue-development-helm-bapi
  - name: AZUREBLOBSTORAGE__CONTAINERNAME
    value: buyingcatalogue-development-helm-documents
  - group: dev-secrets

steps:
- task: UseGitVersion@5
  name: gitversion
  displayName: Work out version
  inputs:
    versionSpec: '5.x'

- task: UseDotNet@2
  displayName: 'Use DotNet Core $(dotnetVersion)'
  inputs:
    version: $(dotnetVersion)
    includePreviewVersions: false

- bash: |
    echo "##vso[task.setvariable variable=PBHOSTURL]$(echo "${PBURL#'https://'}")"
  displayName: Set up PB Host URL

- bash: |
    echo "51.11.46.27    $PBHOSTURL" | sudo tee -a /etc/hosts
    curl -k -i $(PBURL) --fail --connect-timeout 30
  displayName: 'Check URL is reachable'

- bash: |
    ./selenium-grid-setup.sh
    if [ $? -ne 0 ]; then exit 1; fi
  displayName: Selenium Grid Setup

- bash: |
    export DB__PASSWORD="$(gpitfuturesdevdbpassword)" 
    export AZUREBLOBSTORAGE__CONNECTIONSTRING="$(gpitdevstorageaccountconnectionstring)"

    dotnet test src/NHSDPublicBrowseAcceptanceTests.Tests/*.csproj -v n
  displayName: Run Acceptance Tests
  
- task: Docker@2
  condition: and(always(), eq(variables['Build.SourceBranch'], 'refs/heads/development'))
  displayName: Build and push docker image
  inputs:
    containerRegistry: 'gpitfuturesdevacr'
    repository: 'nhsd/buying-catalogue/pb-ac-tests'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: "$(GitVersion.SemVer)"
    addPipelineData: false


