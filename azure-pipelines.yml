trigger:
- development

pr:
- development

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: BROWSER
    value: chrome
  - name: DB__SERVERURL
    value: gpitfutures-dev-sql-pri.database.windows.net
  - name: DB__DATABASENAME
    value: bc-buyingcatalogue-development-helm-bapi
  - name: DB__PASSWORD
    value: "$(gpitfuturesdevdbpassword)"  
  - name: AZUREBLOBSTORAGE__CONTAINERNAME
    value: buyingcatalogue-development-helm-documents
  - name: AZUREBLOBSTORAGE__CONNECTIONSTRING
    value: "$(gpitdevstorageaccountconnectionstring)"
  - group: dev-secrets

steps:
- bash: |
    PBHOSTURL=$(echo "${PBURL#'https://'}")
    echo "51.11.46.27    $PBHOSTURL" | sudo tee -a /etc/hosts
    curl -k -i $(PBURL) --fail --connect-timeout 30
  displayName: 'Check URL is reachable'

- bash: |
    export PBHOSTURL=$(echo "${PBURL#'https://'}")
    docker-compose stop &&
    docker-compose rm -f &&
    docker-compose up --scale chrome=4 -d
    sleep 30
  displayName: Selenium Grid Setup

- task: DotNetCoreCLI@2
  displayName: Run Acceptance Tests
  inputs:
    command: 'test'
    projects: 'src/NHSDPublicBrowseAcceptanceTests.Tests/*.csproj'
    arguments: '-v n'

- task: Docker@2
  inputs:
    containerRegistry: 'gpitfuturesdevacr'
    repository: 'nhsd/buying-catalogue/pb-ac-tests'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: latest
    addPipelineData: false


