trigger:
- development

pr:
- development

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: BROWSER
    value: chrome
  - name: DB__SERVERURL
    value: gpitfutures-dev-sql-pri.database.windows.net
  - name: DB__DATABASENAME
    value: bc-buyingcatalogue-development-helm-bapi
  - name: AZUREBLOBSTORAGE__CONTAINERNAME
    value: buyingcatalogue-development-helm-documents
  - group: dev-secrets

steps:
- task: Docker@2
  inputs:
    containerRegistry: 'gpitfuturesdevacr'
    repository: 'nhsd/buying-catalogue/pb-ac-tests'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: latest
    addPipelineData: false
    
- bash: |
    PBHOSTURL=$(echo "${PBURL#'https://'}")
    echo "51.11.46.27    $PBHOSTURL" | sudo tee -a /etc/hosts
    curl -k -i $(PBURL) --fail --connect-timeout 30
  displayName: 'Check URL is reachable'

- bash: |
    export PBHOSTURL=$(echo "${PBURL#'https://'}")
    docker-compose stop &&
    docker-compose rm -f &&
    docker-compose up --scale chrome=4 -d
    sleep 30
  displayName: Selenium Grid Setup

- bash: |
    docker run \
      --env PBURL="$PBURL" \
      --env BROWSER="$BROWSER" \
      --env HUBURL="http://host.docker.internal:4444/wd/hub" \
      --env DB__SERVERURL="$DB__SERVERURL" \
      --env DB__DATABASENAME="$DB__DATABASENAME" \
      --env DB__PASSWORD="$(gpitfuturesdevdbpassword)" \
      --env AZUREBLOBSTORAGE__CONNECTIONSTRING="$(gpitdevstorageaccountconnectionstring)" \
      --env AZUREBLOBSTORAGE__CONTAINERNAME="$AZUREBLOBSTORAGE__CONTAINERNAME" \
      nhsd/buying-catalogue/pb-ac-tests
  name: runTests
  displayName: Run Acceptance Tests




