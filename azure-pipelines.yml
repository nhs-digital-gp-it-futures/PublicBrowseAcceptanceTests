trigger:
- development

pr:
- development

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: buildConfiguration
    value: 'Release'
  - name: BROWSER
    value: chrome
  - name: DB__SERVERURL
    value: gpitfutures-dev-sql-pri.database.windows.net
  - name: DB__DATABASENAME
    value: bc-buyingcatalogue-development-helm-bapi
  - name: AZUREBLOBSTORAGE__CONTAINERNAME
    value: buyingcatalogue-development-helm-documents
  - group: dev-secrets

steps:
- task: Docker@2
  inputs:
    command: 'build'
    Dockerfile: 'Dockerfile'
    tags: 'pb-ac-tests'

#- task: CopyFiles@2
#  enabled: false
#  inputs:
#    Contents: '**'
#    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    
#- task: PublishBuildArtifacts@1
#  enabled: false
#  inputs:
#    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
#    ArtifactName: 'drop'
#    publishLocation: 'Container'
      
- bash: |
    PBHOSTURL=$(echo "${PBURL#'https://'}")
    echo "51.11.46.27    $PBHOSTURL" | sudo tee -a /etc/hosts
    curl -k -i $(PBURL) --fail --connect-timeout 30
  displayName: 'Check URL is reachable'

- task: Bash@3
  displayName: Selenium Grid Setup
  inputs:
    targetType: 'inline'
    script: |
      docker-compose stop &&
      docker-compose rm -f &&
      docker-compose up --scale chrome=4 --scale firefox=4 -d

- bash: |
    docker run \
      --env PBURL="$PBURL" \
      --env BROWSER="$BROWSER" \
      --env HUBURL="http://host.docker.internal:4444/wd/hub" \
      --env DB__SERVERURL="$DB__SERVERURL" \
      --env DB__DATABASENAME="$DB__DATABASENAME" \
      --env DB__PASSWORD="$(gpitfuturesdevdbpassword)" \
      --env AZUREBLOBSTORAGE__CONNECTIONSTRING="$(gpitdevstorageaccountconnectionstring)" \
      --env AZUREBLOBSTORAGE__CONTAINERNAME="$AZUREBLOBSTORAGE__CONTAINERNAME" \
      pb-ac-tests
  name: runTests
  displayName: Run Acceptance Tests

- task: Docker@2
  displayName: Push image
#  condition: eq(variables['Build.SourceBranch'], 'refs/heads/development')
  inputs:
    azureSubscription: 'NHSAPP-BuyingCatalogue (Non-Prod)'
    azureContainerRegistry: '{"loginServer":"gpitfuturesdevacr.azurecr.io", "id" : "/subscriptions/7b12a8a2-f06f-456f-b6f9-aa2d92e0b2ec/resourceGroups/gpitfutures-dev-rg-acr/providers/Microsoft.ContainerRegistry/registries/gpitfuturesdevacr"}'
    repository: 'pb-ac-tests'
    command: push



